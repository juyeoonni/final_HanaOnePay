<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">



<mapper namespace="com.kopo.finalhanaonepayproject.hanaOnePay.model.DAO.HanaOnePayDAO">

    <select id="getHanaAccountDetailsByIdentity" resultType="com.kopo.finalhanaonepayproject.hanaOnePay.model.DTO.HanaOnePayAccountDTO">
        SELECT a.*
        FROM hana_account a
                 JOIN customer_hana cu ON a.identityNumber = cu.identityNumber
        WHERE cu.identityNumber = #{identityNumber}
    </select>

    <select id="getHanaCardDetailsByIdentity" resultType="com.kopo.finalhanaonepayproject.hanaOnePay.model.DTO.HanaOnePayhanaCardDTO">
        SELECT c.*
        FROM hana_card c
                 JOIN hana_account a ON c.accNumber = a.accNumber
                 JOIN customer_hana cu ON a.identityNumber = cu.identityNumber
        WHERE cu.identityNumber = #{identityNumber}
    </select>

<!--    하나대표카드-->
    <select id="getMainHanaCardByIdentity" resultType="com.kopo.finalhanaonepayproject.hanaOnePay.model.DTO.HanaOnePayhanaCardDTO">
        SELECT c.*
        FROM hana_card c
                 JOIN hana_account a ON c.accNumber = a.accNumber
                 JOIN customer_hana cu ON a.identityNumber = cu.identityNumber
        WHERE cu.identityNumber = #{identityNumber}
    </select>

    <!--    하나신용카드-->
    <select id="getHanaCreditCardByIdentity" resultType="com.kopo.finalhanaonepayproject.hanaOnePay.model.DTO.HanaOnePayhanaCardDTO">
        SELECT c.*
        FROM hana_card c
                 JOIN hana_account a ON c.accNumber = a.accNumber
                 JOIN customer_hana cu ON a.identityNumber = cu.identityNumber
        WHERE cu.identityNumber = #{identityNumber}
        AND c.cardTypeCode = '1'
    </select>

<!--    신용카드의 전월 1일부터 말일까지의 거래내역에서 금액합산-->
    <select id="calculateTotalSpentAmountForPreviousMonth" resultType="java.math.BigDecimal">
        SELECT SUM(PAYAMOUNT) AS TotalAmount
        FROM hana_card_payment_log
        WHERE CARDNUMBER = #{cardNumber}
          AND PAYDATE BETWEEN TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE, -1), 'MM'), 'YYYY-MM-DD')
            AND TO_CHAR(LAST_DAY(ADD_MONTHS(SYSDATE, -1)), 'YYYY-MM-DD')
    </select>


    <select id="getRegisteredCards" parameterType="string" resultType="com.kopo.finalhanaonepayproject.hanaOnePay.model.DTO.HanaOnePayCardDTO">
        SELECT * FROM payCard WHERE identityNumber = #{identityNumber}
    </select>

    <!-- 페이카드 insert -->
    <insert id="insertCard" parameterType="com.kopo.finalhanaonepayproject.hanaOnePay.model.DTO.HanaOnePayCardDTO">
        INSERT INTO payCard (cardNumber, identityNumber, accNumber, cardName, validityPeriod, cardStatus, cvc, joinDate, cardCode, cardTypeCode, limit)
        VALUES (#{cardNumber}, #{identityNumber}, #{accNumber}, #{cardName}, #{validityPeriod}, #{cardStatus}, #{cvc}, SYSDATE, #{cardCode}, #{cardTypeCode}, #{limit})
    </insert>

    <!-- 페이카드 모두 select -->
    <select id="getAllCards" resultType="com.kopo.finalhanaonepayproject.hanaOnePay.model.DTO.HanaOnePayCardDTO">
        SELECT * FROM payCard
    </select>

<!--    &lt;!&ndash;    하나카드 이번달 사용금액 조회 &ndash;&gt;-->
<!--    <select id="" resultType="com.kopo.finalhanaonepayproject.hanaOnePay.model.DTO.HanaOnePayCardDTO">-->
<!--        SELECT SUM(payAmount) AS 이번달_총_사용금액-->
<!--        FROM hana_card_payment_log-->
<!--        WHERE SUBSTR(payDate, 1, 7) = TO_CHAR(SYSDATE, 'YYYY-MM')-->
<!--    </select>-->

    <!--   한 회원이 갖고 있는 하나카드 정보 조회 -->
    <select id="getOnlyHanaCardDetailsByIdentity" resultType="com.kopo.finalhanaonepayproject.hanaOnePay.model.DTO.HanaOnePayhanaCardDTO">
        select c.cardNumber
        from hana_card c
                 JOIN hana_account a ON c.accNumber = a.accNumber
                 JOIN customer_hana cu ON a.identityNumber = cu.identityNumber
        where cu.identityNumber = #{identityNumber}

    </select>
    <!--    하나카드 이번달 거래내역 조회 -->
    <select id="getThisMonthTransData" resultType="com.kopo.finalhanaonepayproject.hanaOnePay.model.DTO.HanaOnePayTransDTO">
        SELECT *
        FROM hana_card_payment_log
        WHERE SUBSTR(payDate, 1, 7) = TO_CHAR(SYSDATE, 'YYYY-MM')
        AND cardNumber = #{cardNumber}
    </select>

<!--    하나카드 이번달 총 사용 금액-->
    <select id="getThisMonthTotalAmount" resultType="int">
        SELECT SUM(payAmount) AS 이번달_총_사용금액
        FROM hana_card_payment_log
        WHERE SUBSTR(payDate, 1, 7) = TO_CHAR(SYSDATE, 'YYYY-MM')
        AND cardNumber = #{cardNumber}
    </select>



    <select id="">
        select distinct l.cardNumber
        from hana_card_payment_log l
                 JOIN hana_card c ON l.cardNumber = c.cardNumber
                 JOIN hana_account a ON c.accNumber = a.accNumber
                 JOIN customer_hana cu ON a.identityNumber = cu.identityNumber
        where cu.identityNumber = #{identityNumber};
    </select>

    <select id="getCardsByBusinessCodes" parameterType="list" resultType="com.kopo.finalhanaonepayproject.hanaOnePay.model.DTO.CardItemDTO">
        SELECT ci.cardName, ci.cardTypeCode, ci.cardDesc, ci.annualFee
        FROM cardItem ci
        JOIN cardBenefit cb ON ci.cardName = cb.cardName
        WHERE cb.businessCode IN
        <foreach item="businessCode" collection="list" open="(" separator="," close=")">
            #{businessCode}
        </foreach>
    </select>

</mapper>